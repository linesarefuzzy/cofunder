<% content_for :title, @loan.name %>
<% fluid = @embedded ? '-fluid' : '' %>

<% content_for :head do %>
<script>
  $(function () {
    // Javascript to enable link to tab
    var hash = document.location.hash;
    var prefix = "_";
    if (hash)
      $('.nav-tabs a[href='+hash.replace(prefix,"")+']').tab('show');
    else 
      $('.nav-tabs a:first').tab('show'); // Select first tab

    // Initiate slideshow
    $('.carousel-inner .item').first().addClass('active')
    $('.carousel-indicators li').first().addClass('active')
    $('.carousel').carousel('fade')
  })
</script>
<% end #content_for %>

<div class="container<%=fluid%> loans detail_page">
  <div class="row<%=fluid%>">
    <div class="span7">
      <div class="back_link pull-left">
        <a class="btn-link" href="<%= url_for (@embedded ? embedded_loans_path : loans_path) %>">
          <i class="icon-chevron-left"></i> Back to Loan List</a>
      </div>
      <!-- 
      <div class="btn-group pull-right" data-toggle="buttons-radio">
        <button type="button" class="btn">English</button>
        <button type="button" class="btn">Spanish</button>
      </div>
      -->
    </div>
  </div><!-- /.row -->
  
  <div class="row<%=fluid%>">
    <div class="span7 main_content">
      <div class="detail_wrap">
        <h1 class="section-title"><%= @loan.name %></h1>
       
        <% if @pictures %>
          <div id="myCarousel" class="carousel slide">
            <% if @pictures.count > 1 %>
              <ol class="carousel-indicators">
                <% for i in (0..(@pictures.count-1)) do %>
                  <li data-target="#myCarousel" data-slide-to="<%=i%>"></li>
                <% end %>
              </ol>
            <% end %>

            <!-- Carousel items -->
            <!-- <a href="<%= url_for %>/gallery"> -->
              <div class="carousel-inner">
                <% @pictures.each do |path| %>
                  <div class="item picture" style="background-image: url(<%= path[:large] %>);"></div>
                <% end %>
              </div>
            <!-- </a> -->

            <!-- Carousel nav -->
            <% if @pictures.count > 1 %>
              <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
              <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
            <% end %>
          </div> <!-- /carousel -->
        <% end #if @pictures %>

        <!--
        <div class="lend">
          <a class="button lend_button pull-right" href="<%= url_for '#' %>"></a><br/><br/>
        </div>
        <h5 class="coop_name">Current Report</h5> 
        -->
        <div class="short_description update-box update-box-color">
          <div class="info">Status: <%= @loan.status %>
          <i class="icon-coinstack"></i> <%= @loan.amount_formatted %>
          <i class="icon-map-marker"></i> <%= @loan.location %>
          <i class="icon-calendar"></i>  <%= @loan.signing_date_pretty %></div>
          <div class="short_description"><%= @loan.get_short_description %></div>
        </div>
        <div class="loan-feed-block">
        <ul class="timeline loan-feed">
          <% @loan.project_events.each do |paso| %>
            <li class="paso active <%= paso.completed_or_not %>"><br />
              <p class="paso_short_desc well clearfix">
                <i class=" icon-large icon-user"></i> <span class="paso-summary"><%= paso.summary %></span> 
                <span class="paso-date"><i class="icon-calendar"></i> <strong><%= paso.display_date %></strong></span><br />
                <span class="paso-status"><%= paso.status %></span>
              </p>
             
              <% if paso.Completed %>
                <p class="paso_completed"><%= paso.Completed %></p>
              <% else %>
                <p class="paso_completed"><strong>(Not yet completed)</strong></p>
              <% end %>
              <% unless paso.Details.blank? %><br>Details: <%= paso.Details %><% end %>
              <ul>
                <% paso.logs.each do |log| %>
                  <li class="log logs-body <%= log.Progress.parameterize.underscore %>">
                  <li><strong>Loan Logs</strong> <i class="icon-calendar"></i> <strong> <%= log.date %></strong> <strong class="log-progress">Progress: <%= log.Progress %></strong> </li>
                    <p class="log-inner"><i class="icon-adjust"></i> <%= log.explanation %></p><br /> <br /></li>
                <% end %>
              </ul>
            </li>
          <% end %>
        </ul>
        </div><!-- /.loan-feed-block -->
      </div><!-- /.detail_wrap -->
    </div><!-- /.span7.main_content -->

    <div class="span5 sidebar">
      <ul class="nav nav-tabs">
        <li><a href="#summary" data-toggle="tab">Summary</a></li>
        <li><a href="#contracts" data-toggle="tab">Contracts</a></li>
        <li><a href="#other_loans" data-toggle="tab">Past Loans</a></li>
        <% unless @repayments.empty? %>
          <li><a href="#payments" data-toggle="tab">Payments</a></li>
        <% end %>
      </ul>
      
      <div id="about_loan" class="tab-content">
        <div class="tab-pane" id="summary">
          <h4 class="section-title">About This Project</h4>
          <div class="description_box well">
            <p class="loan_description detail_gutter">
              <%= @loan.get_description || '<span style="font-style:italic;" class="notfound">No description found.</span>' %>
            </p>
          </div>
        </div>

        <div class="tab-pane" id="contracts">
          <h4>All Contracts for this Co-op</h4>
          <table>
            <tr>
              <td>Loan Name</td>
            </tr>
            <tr>
              <td>Loan Officer</td>
            </tr>
            <tr>
              <td>Loan Contract</td>
            </tr>
          </table>
        </div>
        <div class="tab-pane" id="other_loans">
          <% if !@other_loans || @other_loans.count <= 1 %>
            <p class="empty">This is the first loan to this cooperative.</p>
          <% else %>
            <h4>All Loans to this Co-op</h4>
            <table class="table other_loans" data-provides="rowlink">
              <% @other_loans.each do |loan| %>
                <tr class="<%= 'selected' if loan.id == @loan.id %>">
                  <td>
                    <% if loan.id == @loan.id %>
                      <%= loan.signing_date_pretty %>
                    <% else %>
                      <a class="rowlink" href="<%= url_for (@embedded ? embedded_loan_path(loan) : loan) %>#_other_loans">
                        <%= loan.signing_date_pretty %></a>
                    <% end %>
                  </td>
                  <td><%= loan.amount_formatted %></td>
                  <td><%= loan.status %></td>
                </tr>
              <% end %>
            </table>
          <% end %>
        </div>
        
        <% unless @repayments.empty? %>
          <div class="tab-pane" id="payments">
            <h4>Payment Schedule</h4>
            <table class="table repayments">
              <!-- <tr>
                <th>Status</th>
                <th>Amount</th>
              </tr> -->
              <% @repayments.each do |pmt| %>
                <tr class="<%= pmt.status %>">
                  <td><%= pmt.status_date %></td>
                  <td><%= pmt.amount_formatted %></td>
                </tr>
              <% end %>
            </table>
          </div>
        <% end %>

      </div><!-- /#about_loan -->
    </div><!-- /.span5.sidebar -->
    
  </div><!-- /.row -->
</div><!-- /.container -->
